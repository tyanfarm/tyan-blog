<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-build-llm-from-scratch/llm-architecture-01" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">4. LLM Architecture (Part 01) | Tyan Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://github.com/tyan-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://github.com/tyan-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://github.com/tyan-blog/docs/build-llm-from-scratch/llm-architecture-01"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="4. LLM Architecture (Part 01) | Tyan Blog"><meta data-rh="true" name="description" content="4.1. Code LLM architecture"><meta data-rh="true" property="og:description" content="4.1. Code LLM architecture"><link data-rh="true" rel="icon" href="/tyan-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://github.com/tyan-blog/docs/build-llm-from-scratch/llm-architecture-01"><link data-rh="true" rel="alternate" href="https://github.com/tyan-blog/docs/build-llm-from-scratch/llm-architecture-01" hreflang="en"><link data-rh="true" rel="alternate" href="https://github.com/tyan-blog/docs/build-llm-from-scratch/llm-architecture-01" hreflang="x-default"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/tyan-blog/assets/css/styles.1c32e954.css">
<script src="/tyan-blog/assets/js/runtime~main.287dafb7.js" defer="defer"></script>
<script src="/tyan-blog/assets/js/main.64aeb383.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/tyan-blog/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tyan-blog/"><div class="navbar__logo"><img src="/tyan-blog/img/logo.svg" alt="Tyan Blog Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/tyan-blog/img/logo.svg" alt="Tyan Blog Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Tyan Blog</b></a><a class="navbar__item navbar__link" href="/tyan-blog/docs/category/interviews/">Interview</a><a class="navbar__item navbar__link" href="/tyan-blog/docs/category/build-llm-from-scratch/">LLM</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/tyan-blog/docs/category/interviews">Interviews</a><button aria-label="Expand sidebar category &#x27;Interviews&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/tyan-blog/docs/category/build-llm-from-scratch">Build LLM from Scratch</a><button aria-label="Collapse sidebar category &#x27;Build LLM from Scratch&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tyan-blog/docs/build-llm-from-scratch/state-of-building-LLMs">1. State of building LLMs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tyan-blog/docs/build-llm-from-scratch/data-preparation-and-sampling">2. Data Preparation and Sampling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tyan-blog/docs/build-llm-from-scratch/attention-mechanisms-01">3. Coding Attention Mechanisms (Part 01)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tyan-blog/docs/build-llm-from-scratch/attention-mechanisms-02">3. Coding Attention Mechanisms (Part 02)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tyan-blog/docs/build-llm-from-scratch/attention-mechanisms-03">3. Coding Attention Mechanisms (Part 03)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tyan-blog/docs/build-llm-from-scratch/attention-mechanisms-04">3. Coding Attention Mechanisms (Part 04)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tyan-blog/docs/build-llm-from-scratch/attention-mechanisms-05">3. Coding Attention Mechanisms (Part 05)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/tyan-blog/docs/build-llm-from-scratch/llm-architecture-01">4. LLM Architecture (Part 01)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tyan-blog/docs/build-llm-from-scratch/appendix">Appendix</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/tyan-blog/docs/build-llm-from-scratch/bonus-section/normalization">bonus-section</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/tyan-blog/docs/category/machine-learning">Machine Learning</a><button aria-label="Expand sidebar category &#x27;Machine Learning&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/tyan-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/tyan-blog/docs/category/build-llm-from-scratch"><span itemprop="name">Build LLM from Scratch</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">4. LLM Architecture (Part 01)</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>4. LLM Architecture (Part 01)</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="41-code-llm-architecture">4.1. Code LLM architecture<a href="#41-code-llm-architecture" class="hash-link" aria-label="Direct link to 4.1. Code LLM architecture" title="Direct link to 4.1. Code LLM architecture">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gpt-backbone">GPT Backbone<a href="#gpt-backbone" class="hash-link" aria-label="Direct link to GPT Backbone" title="Direct link to GPT Backbone">​</a></h3>
<ul>
<li>
<p>Các mô hình Ngôn ngữ lớn (LLM) như GPT (Generative Pretrained Transformer) là những kiến trúc mạng nơ-ron có kích thước khổng lồ.</p>
</li>
<li>
<p>Tuy nhiên, kiến trúc của mô hình này thực chất lại ít phức tạp hơn bạn tưởng, bởi nhiều thành phần bên trong được lặp đi lặp lại (chúng ta sẽ tìm hiểu sau).</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="alt" src="/tyan-blog/assets/images/llm-01-overall-9f1a2afeabbd3dd399cb799f9ec12340.png" width="896" height="718" class="img_ev3q"></p>
</li>
<li>
<p>Phía trên là hình mô tả tổng quát về <em>1 mô hình GPT</em>. Bên cạnh các <code>embedding layers</code> &amp; <code>inputs tokenization</code>, nó bao gồm <em>1 hoặc nhiều</em> khối <code>Transformer</code> chứa module <code>masked multi-head attention</code> (đã triển khai ở chương trước).</p>
</li>
<li>
<p>Trọng tâm ở chương này sẽ triển khai <em>core</em> của LLM, bao gồm các <em>khối transformer</em>, sau đó chúng ta sẽ <em>huấn luyện</em> ở chương tiếp theo để tạo ra văn bản giống con người.</p>
</li>
<li>
<p>Dưới đây là mô tả các bước để build 1 mô hình GPT hoàn chỉnh.</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="alt" src="/tyan-blog/assets/images/llm-02-backbone-94bbd0e89891c8135cd9d125e80475a3.png" width="1068" height="449" class="img_ev3q"></p>
</li>
<li>
<p>Bắt đầu với bước đầu tiên là xây dựng <code>GPT Backbone</code>, ta sẽ triển khai 1 class là <code>DummyGPTModel</code> - phiên bản đơn giản hóa của mô hình GPT, sử dụng module neural network của Pytorch <em>nn.Module</em>. Kiến trúc của mô hình được triển khai tại phần <code>1. GPT Backbone</code> trong <a href="https://github.com/tyanfarm/build-LLM-from-scratch-notebook/blob/main/11.%20Placeholder-GPT.ipynb" target="_blank" rel="noopener noreferrer"><code>11. Placeholder-GPT.ipynb</code></a>.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="layer-normalization">Layer Normalization<a href="#layer-normalization" class="hash-link" aria-label="Direct link to Layer Normalization" title="Direct link to Layer Normalization">​</a></h3>
<ul>
<li>
<p>Việc huấn luyện <code>deep neural network</code> (mạng nơ-ron sâu) với nhiều tầng <code>hidden layer</code> dễ gặp vấn đề như <em>vanishing gradient (triệt tiêu đạo hàm)</em> hay <em>exploding gradient (bùng nổ đạo hàm)</em>. Điều này có nghĩa mô hình sẽ gặp khó khăn trong việc tìm ra bộ tham số tối ưu để giảm <em>loss</em>.</p>
</li>
<li>
<p>Phần này chúng ta sẽ triển khai <code>layer normalization</code>. Ý tưởng chính là điều chỉnh các giá trị kích hoạt (<code>activations</code>) đầu ra của 1 <em>hidden layer</em> sao cho chúng có <em>giá trị trung bình (<a href="/tyan-blog/docs/machine-learning/base-math/probability-statistics#trung-b%C3%ACnh-c%E1%BB%99ng-mean">mean</a>)</em> bằng 0 và <em>phương sai (<a href="/tyan-blog/docs/machine-learning/base-math/probability-statistics#ph%C6%B0%C6%A1ng-sai-variance">variance</a>)</em> bằng 1 - việc điều chỉnh <em>mean</em> &amp; <em>variance</em> này là của <a href="/tyan-blog/docs/build-llm-from-scratch/bonus-section/normalization#standardization-z-score-normalization">Standardization</a>. Để ý thêm 1 điều là tại sao lại chuẩn hóa theo 2 giá trị này, thì bởi vì <a href="/tyan-blog/docs/machine-learning/base-math/probability-statistics#ph%C3%A2n-ph%E1%BB%91i-chu%E1%BA%A9n-gaussiannormal-distribution">Phân phối chuẩn</a> dựa trên 2 tham số này.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="tại-sao-lại-cần-standardization-z-score">Tại sao lại cần Standardization Z-score?<a href="#tại-sao-lại-cần-standardization-z-score" class="hash-link" aria-label="Direct link to Tại sao lại cần Standardization Z-score?" title="Direct link to Tại sao lại cần Standardization Z-score?">​</a></h5>
<ul>
<li>Khi dữ liệu truyền qua từng lớp, nếu <em>giá trị kích hoạt</em> thay đổi <em>quá lớn</em> hoặc <em>quá nhỏ</em>, thì khi <em>backprobagation</em> sẽ bị <em>bùng nổ</em> hoặc <em>triệt tiêu</em> <em>đạo hàm</em>. Do đó, <code>LayerNorm</code> sử dụng <em>z-score</em> để chuẩn hóa dữ liệu đưa về thang đo chung ở mỗi bước.</li>
</ul>
</li>
<li>
<p>Trong <em>GPT-2</em> và các kiến trúc <em>Transformer</em> hiện đại, <em>Layer Normalization</em> thường được áp dụng <em>trước và sau</em> khối <em>multi-head attention</em> và trước <em>output layer</em>.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="hàm-kích-hoạt-activations">Hàm kích hoạt (Activations)<a href="#hàm-kích-hoạt-activations" class="hash-link" aria-label="Direct link to Hàm kích hoạt (Activations)" title="Direct link to Hàm kích hoạt (Activations)">​</a></h5>
<ul>
<li>Khi đi qua các tầng <em>Linear</em> thì mô hình chỉ học được các mối quan hệ tuyến tính.</li>
<li>Hàm kích hoạt lúc này giúp mô hình học thêm các mối quan hệ phi tuyến tính. Ví dụ hàm <em>ReLU</em> chuyển các giá trị âm về 0.</li>
</ul>
</li>
<li>
<p>Trước khi đi vào phần triển khai code ta hãy xem qua sơ đồ tổng quan của <em>layer normalization</em>:</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="alt" src="/tyan-blog/assets/images/llm-03-layer-normalization-e53a3b19c6f8b2711e0e1a0733f025d7.png" width="1137" height="691" class="img_ev3q"></p>
</li>
<li>
<p>Ở hình trên, khi đi qua tầng <em>hidden layer</em> thì các giá trị đầu ra sẽ được tính toán để đưa về trạng thái có <em>mean bằng 0 &amp; variance bằng 1</em>. Quá trình này giúp ổn định dòng dữ liệu và tăng tốc độ hội tụ mô hình.</p>
</li>
<li>
<p>Code được triển khai tại phần <code>2. Layer Normalization</code> trong <a href="https://github.com/tyanfarm/build-LLM-from-scratch-notebook/blob/main/11.%20Placeholder-GPT.ipynb" target="_blank" rel="noopener noreferrer"><code>11. Placeholder-GPT.ipynb</code></a>.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="chiều-dimension-khi-tính-mean">Chiều (dimension) khi tính <em>mean</em><a href="#chiều-dimension-khi-tính-mean" class="hash-link" aria-label="Direct link to chiều-dimension-khi-tính-mean" title="Direct link to chiều-dimension-khi-tính-mean">​</a></h5>
<ul>
<li>
<p><img decoding="async" loading="lazy" alt="alt" src="/tyan-blog/assets/images/llm-04-mean-dimension-b5bb8156ae979990ecee13efac25605d.png" width="767" height="543" class="img_ev3q"></p>
</li>
<li>
<p>Trên đây là mô tả về chiều tính toán <em>mean</em> trên 1 tensor 2D <em>[rows, columns]</em>.</p>
</li>
<li>
<p>Việc sử dụng <code>dim=-1</code> giúp tính <em>mean</em> trên chiều cuối cùng của tensor. Sau này, khi thêm <em>chuẩn hóa lớp (layer normalization)</em> - nơi tạo ra tensor 3D <em>[batch_size, num_tokens, embedding_dim]</em> thì việc giữ nguyên <em>dim=-1</em> linh hoạt hơn nhiều so với phải thay đổi thủ công từ <em>dim=1</em> sang <em>dim=2</em>.</p>
</li>
</ul>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="alt" src="/tyan-blog/assets/images/llm-05-layernorm-finish-f8b352c7b528ce5c9f626aaaa4eca672.png" width="1160" height="542" class="img_ev3q"></p>
</li>
<li>
<p>Phần sau ta sẽ tìm hiểu về <em>hàm kích hoạt</em> <code>GeLU</code> - một trong các hàm kích hoạt dùng trong LLMs, thay cho hàm truyền thống <em>ReLU</em>.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gelu-activations">GeLU Activations<a href="#gelu-activations" class="hash-link" aria-label="Direct link to GeLU Activations" title="Direct link to GeLU Activations">​</a></h3>
<ul>
<li>
<p>Trước đây, hàm kích hoạt <code>ReLU</code> đã được sử dụng phổ biến trong học sâu nhờ tính đơn giản và hiệu quả trên nhiều kiến trúc mạng nơ-ron khác nhau. Tuy nhiên, trong các mô hình ngôn ngữ lớn (LLM), người ta thường sử dụng các hàm kích hoạt khác thay thế cho ReLU truyền thống. Hai ví dụ tiêu biểu là <code>GeLU</code> <em>(Gaussian Error Linear Unit)</em> và <code>SwiGLU</code><em>(Sigmoid-Weighted Linear Unit)</em>, lần lượt tích hợp các <em>đơn vị tuyến tính</em> kiểm soát bởi <em>phân phối</em> <code>Gaussian</code> &amp; <code>Sigmoid</code>.</p>
</li>
<li>
<p><em>Hàm kích hoạt GeLU</em> có thể được triển khai theo nhiều cách khác nhau. Phiên bản chính xác được xác định là <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mi>E</mi><mi>L</mi><mi>U</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>x</mi><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">GELU(x) = x \Phi(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.05764em">GE</span><span class="mord mathnormal" style="margin-right:0.10903em">LU</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">x</span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>, với <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Phi(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> là <code>hàm phân phối tích lũy</code> của <a href="/tyan-blog/docs/machine-learning/base-math/probability-statistics#ph%C3%A2n-ph%E1%BB%91i-chu%E1%BA%A9n-gaussiannormal-distribution">Phân phối Gaussian chuẩn</a>.</p>
</li>
<li>
<p>Tuy nhiên trong thực tế người ta thường triển khai 1 bản xấp xỉ có chi phí tính toán thấp hơn (GPT-2 gốc cũng sử dụng):</p>
</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mi>E</mi><mi>L</mi><mi>U</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>≈</mo><mn>0.5</mn><mo>⋅</mo><mi>x</mi><mo>⋅</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mi>tanh</mi><mo>⁡</mo><mo stretchy="false">[</mo><msqrt><mrow><mn>2</mn><mi mathvariant="normal">/</mi><mi>π</mi></mrow></msqrt><mo>⋅</mo><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mn>0.044715</mn><mo>⋅</mo><msup><mi>x</mi><mn>3</mn></msup><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">GELU(x) \approx 0.5 \cdot x \cdot (1 + \tanh[\sqrt{2/\pi} \cdot (x + 0.044715 \cdot x^3)])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.05764em">GE</span><span class="mord mathnormal" style="margin-right:0.10903em">LU</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.5</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.305em"></span><span class="mop">tanh</span><span class="mopen">[</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em"><span class="svg-align" style="top:-3.2em"><span class="pstrut" style="height:3.2em"></span><span class="mord" style="padding-left:1em"><span class="mord">2/</span><span class="mord mathnormal" style="margin-right:0.03588em">π</span></span></span><span style="top:-2.895em"><span class="pstrut" style="height:3.2em"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewBox="0 0 400000 1296" preserveAspectRatio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.044715</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)])</span></span></span></span></p>
<ul>
<li>Code được triển khai tại phần <code>3. GeLU Activations</code> trong <a href="https://github.com/tyanfarm/build-LLM-from-scratch-notebook/blob/main/11.%20Placeholder-GPT.ipynb" target="_blank" rel="noopener noreferrer"><code>11. Placeholder-GPT.ipynb</code></a>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="feed-forward-network">Feed Forward Network<a href="#feed-forward-network" class="hash-link" aria-label="Direct link to Feed Forward Network" title="Direct link to Feed Forward Network">​</a></h3>
<ul>
<li>
<p>Lớp <code>FeedForward (FNN)</code> là 1 mạng nơ-ron nhỏ gồm <em>2 phép biến đổi tuyến tính</em> và <em>1 hàm kích hoạt phi tuyến</em> (ở phần này ta sẽ dùng <em>GeLU</em>):</p>
<ul>
<li>
<p><em>Mở rộng không gian</em>: FNN đưa các vector đầu vào từ không gian <em>embedding-dim</em> lên không gian có số chiều lớn hơn (ở phần này là <em>gấp 4 lần</em>).</p>
</li>
<li>
<p>Sau đó các vector sẽ được đưa qua <em>1 hàm kích hoạt</em> để học được các đặc trưng phi tuyến và loại bỏ các đặc trưng nhiễu.</p>
</li>
<li>
<p>Cuối cùng, các vector được chiếu ngược lại về không gian ban đầu để đi tiếp vào các layers sau.</p>
</li>
</ul>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="alt" src="/tyan-blog/assets/images/attention_22_ffn-cffc62acb368c0f500f2dea6de75f4a7.png" width="883" height="570" class="img_ev3q"></p>
</li>
<li>
<p>Code được triển khai tại phần <code>4. Feed Forward Network</code> trong <a href="https://github.com/tyanfarm/build-LLM-from-scratch-notebook/blob/main/11.%20Placeholder-GPT.ipynb" target="_blank" rel="noopener noreferrer"><code>11. Placeholder-GPT.ipynb</code></a>.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="shortcut-connections">Shortcut Connections<a href="#shortcut-connections" class="hash-link" aria-label="Direct link to Shortcut Connections" title="Direct link to Shortcut Connections">​</a></h3>
<ul>
<li>
<p><em>Shortcut Connections</em>, hay còn gọi là <em>skip hoặc residual connections</em> ban đầu được đề xuất trong các mạng nơ-ron sâu trong lĩnh vực CV (Computer Vision) cụ thể là các mạng <em>Residual - ResNet</em> nhằm giảm thiểu thách thức về <code>Vanishing Gradient</code> (triệt tiêu đạo hàm).</p>
<ul>
<li>
<p><img decoding="async" loading="lazy" alt="alt" src="/tyan-blog/assets/images/vanishing_gradient-d4775d5ace629be3ad1ecad8965f7678.png" width="291" height="173" class="img_ev3q"></p>
</li>
<li>
<p><em>Vanishing Gradient</em> là hiện tượng khi mạng quá sâu, các đạo hàm (<em>gradient</em>) phải nhân với nhau nhiều lần khi truyền ngược từ cuối về đầu (<a href="/tyan-blog/docs/build-llm-from-scratch/appendix#%C4%91%E1%BA%A1o-h%C3%A0m--gradients">Backpropagation</a>). Nếu các giá trị này <em>nhỏ hơn 1</em> chúng sẽ càng nhân càng nhỏ.</p>
</li>
</ul>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="alt" src="/tyan-blog/assets/images/shortcut_connections-46bef8dd65d1bc3692abe4f93b4658c2.png" width="1013" height="916" class="img_ev3q"></p>
</li>
<li>
<p>Ở hình trên là 2 mạng nơ-ron sâu gồm 5 lớp <em>có shortcut connections</em> (bên phải) &amp; <em>không có shortcut connections</em> (bên trái). Có thể thấy ở bên trái khi về <em>Layer 1</em> thì <em>gradient</em> nó đã về rất bé.</p>
</li>
<li>
<p>Để dễ hiểu thì <code>shortcut connections</code> là <em>cộng đầu ra của 1 lớp với giá trị đầu vào trước khi qua lớp đó</em>, triển khai qua công thức sau đây: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">y = f(x) + x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">x</span></span></span></span></p>
<ul>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">x</span></span></span></span>: là dữ liệu đầu vào trước khi đi qua lớp nơ-ron.</p>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">y = f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>: đầu ra của 1 lớp Linear.</p>
</li>
</ul>
</li>
<li>
<p><em>Tại sao lại là công thức này?</em></p>
<ul>
<li>
<p>Vì khi đi qua đạo hàm thì công thức này sẽ thành: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>y</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac><mo>=</mo><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\frac{\partial y}{\partial x} = \frac{\partial (f(x) + x)}{\partial x} = f&#x27;(x) + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2772em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.4461em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.355em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.485em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.10764em">f</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span></p>
</li>
<li>
<p><em>Khi áp dụng vào backprobagation</em> để tính Gradient truyền về: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>y</mi></mrow></mfrac><mo>⋅</mo><mo stretchy="false">(</mo><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mn mathvariant="bold">1</mn><mo stretchy="false">)</mo><mo>=</mo><munder accentunder="true"><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>y</mi></mrow></mfrac><mo>⋅</mo><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><mo stretchy="true">‾</mo></munder><mo>+</mo><munder accentunder="true"><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>y</mi></mrow></mfrac><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\frac{\partial Loss}{\partial x} = \frac{\partial Loss}{\partial y} \cdot (f&#x27;(x) + \mathbf{1}) = \underline{\frac{\partial Loss}{\partial y} \cdot f&#x27;(x)} + \underline{\frac{\partial Loss}{\partial y}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight">oss</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.3612em;vertical-align:-0.4811em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight">oss</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4811em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathbf">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.5612em;vertical-align:-0.6811em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.3589em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight">oss</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4811em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6811em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.5612em;vertical-align:-0.6811em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.3589em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight">oss</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4811em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6811em"><span></span></span></span></span></span></span></span></span></p>
</li>
<li>
<p>Nếu <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f&#x27;(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> có giảm nhỏ bao nhiêu thì <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>y</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial Loss}{\partial y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3612em;vertical-align:-0.4811em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight">oss</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4811em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> vẫn giúp <em>gradient được truyền ngược về đầu</em> mà không bị <em>triệt tiêu</em>.</p>
</li>
</ul>
</li>
<li>
<p>Code được triển khai tại phần <code>5. Shortcut Connection</code> trong <a href="https://github.com/tyanfarm/build-LLM-from-scratch-notebook/blob/main/11.%20Placeholder-GPT.ipynb" target="_blank" rel="noopener noreferrer"><code>11. Placeholder-GPT.ipynb</code></a>.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transformer-block">Transformer Block<a href="#transformer-block" class="hash-link" aria-label="Direct link to Transformer Block" title="Direct link to Transformer Block">​</a></h3>
<ul>
<li>
<p>Phần này chúng ta sẽ triển khai đầy đủ các thành phần của 1 khối <em>Transformer</em> hoàn chỉnh. Khối này được lặp lại hàng chục lần trong kiến trúc <em>GPT-2 124M tham số</em>, kết hợp với nhiều khái niệm chúng ta đã tìm hiểu trước đó: <code>multi-head attention</code>, <code>layer normalization</code>, <code>dropout</code>, <code>feed-forward layer</code> &amp; <code>GeLU activations</code>. Phần sau ta sẽ kết nối <em>khối Transformer</em> với các phần còn lại của <em>kiến trúc GPT</em>.</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="alt" src="/tyan-blog/assets/images/transformer-block-6869be7a75ad2ed91e2e1974b630b7db.png" width="1202" height="1179" class="img_ev3q"></p>
</li>
<li>
<p>Ý tưởng cốt lõi là <em>cơ chế self-attention</em> trong khối <em>multi-head</em> sẽ xác định và phân tích các mối quan hệ giữa từng token đầu vào. Ngược lại, <em>mạng feed-forward</em> sẽ sửa lỗi độc lập từng vị trí.</p>
</li>
<li>
<p>Code được triển khai tại phần <code>6. Transformer Block</code> trong <a href="https://github.com/tyanfarm/build-LLM-from-scratch-notebook/blob/main/11.%20Placeholder-GPT.ipynb" target="_blank" rel="noopener noreferrer"><code>11. Placeholder-GPT.ipynb</code></a>.</p>
</li>
<li>
<p><em>LayerNorm</em> được áp dụng trước <em>MultiHeadAttention</em> &amp; mạng <em>FeedForward</em>, và <em>Dropout</em> được áp dụng sau để điều tiết mô hình và ngăn chặn <em>overfitting</em>. Cấu trúc này được gọi là <code>Pre-LayerNorm</code>, các kiến trúc cũ hơn như Transformer nguyên bản áp dụng <em>chuẩn hóa</em> sau mạng self-attention &amp; feed-forward, được gọi là <code>Post-LayerNorm</code> - thường dẫn đến động lực huấn luyện (<em>training dynamics</em>) kém hơn.</p>
</li>
<li>
<p>Việc kích thước vector được giữ nguyên khi đi qua <em>khối Transformer</em> là thiết kế cho phép ứng dụng hiệu quả trên phạm vi rộng các tác vụ chuỗi sang chuỗi <em>(Sequence-to-Sequence)</em>, nơi mỗi vector đầu ra tương ứng trực tiếp với vector đầu vào, duy trì quan hệ 1-1, đồng thời tích hợp thông tin ngữ cảnh từ khắp toàn bộ chuỗi input ban đầu.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gpt-model">GPT model<a href="#gpt-model" class="hash-link" aria-label="Direct link to GPT model" title="Direct link to GPT model">​</a></h3></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/tyanfarm/tyan-blog/tree/main/docs/build-llm-from-scratch/4. llm-architecture-01.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/tyan-blog/docs/build-llm-from-scratch/attention-mechanisms-05"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">3. Coding Attention Mechanisms (Part 05)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/tyan-blog/docs/build-llm-from-scratch/appendix"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Appendix</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#41-code-llm-architecture" class="table-of-contents__link toc-highlight">4.1. Code LLM architecture</a><ul><li><a href="#gpt-backbone" class="table-of-contents__link toc-highlight">GPT Backbone</a></li><li><a href="#layer-normalization" class="table-of-contents__link toc-highlight">Layer Normalization</a></li><li><a href="#gelu-activations" class="table-of-contents__link toc-highlight">GeLU Activations</a></li><li><a href="#feed-forward-network" class="table-of-contents__link toc-highlight">Feed Forward Network</a></li><li><a href="#shortcut-connections" class="table-of-contents__link toc-highlight">Shortcut Connections</a></li><li><a href="#transformer-block" class="table-of-contents__link toc-highlight">Transformer Block</a></li><li><a href="#gpt-model" class="table-of-contents__link toc-highlight">GPT model</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/tyanfarm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
</body>
</html>